<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Analying The Change Frequency Of Active Users Tokens From Tomcat Logs - MetaDefine - A super concise theme for Hugo</title>
  <link rel="alternate" hreflang="en" href="/" />

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">
<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="mitui" /><meta name="description" content="Using sed and awk to analyze the change frequency of active users&#39; token from Tomcat log" />
<meta name="keywords" content="AxdLog, awk, sed" />







<meta name="generator" content="Hugo 0.46" />


<link rel="canonical" href="/2016/analying-the-change-frequency-of-active-users-tokens-from-tomcat-logs/" />



<link rel="icon" href="/favicon.ico" />










<link href="/dist/jane.min.css?v=2.7.0" rel="stylesheet">




<meta property="og:title" content="Analying The Change Frequency Of Active Users Tokens From Tomcat Logs" />
<meta property="og:description" content="Using sed and awk to analyze the change frequency of active users&#39; token from Tomcat log" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/2016/analying-the-change-frequency-of-active-users-tokens-from-tomcat-logs/" />



<meta property="article:published_time" content="2016-12-05T07:43:08&#43;08:00"/>

<meta property="article:modified_time" content="2018-04-11T09:37:08-04:00"/>











<meta itemprop="name" content="Analying The Change Frequency Of Active Users Tokens From Tomcat Logs">
<meta itemprop="description" content="Using sed and awk to analyze the change frequency of active users&#39; token from Tomcat log">


<meta itemprop="datePublished" content="2016-12-05T07:43:08&#43;08:00" />
<meta itemprop="dateModified" content="2016-12-05T07:43:08&#43;08:00" />
<meta itemprop="wordCount" content="4484">



<meta itemprop="keywords" content="awk,sed,Shell Script,MySQL," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Analying The Change Frequency Of Active Users Tokens From Tomcat Logs"/>
<meta name="twitter:description" content="Using sed and awk to analyze the change frequency of active users&#39; token from Tomcat log"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">MetaDefine</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        <a href="/">
          Home
        </a>
      </li><li class="mobile-menu-item">
        <a href="/tags/">
          Tags
        </a>
      </li><li class="mobile-menu-item">
        <a href="/post/">
          Archives
        </a>
      </li><li class="mobile-menu-item">
        <a href="/categories/">
          Categories
        </a>
      </li><li class="mobile-menu-item">
        <a href="/about/">
          About
        </a>
      </li>
  </ul>
</nav>

  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  
  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      MetaDefine
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="/">Home</a>
          

        

      </li>
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="/tags/">Tags</a>
          

        

      </li>
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="/post/">Archives</a>
          

        

      </li>
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="/categories/">Categories</a>
          

        

      </li>
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="/about/">About</a>
          

        

      </li>
    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">Analying The Change Frequency Of Active Users Tokens From Tomcat Logs</h1>
      
      <div class="post-meta">
        <span class="post-time"> 2016-12-05 </span>
        <div class="post-category">
            
              <a href="/categories/production-case/"> Production Case </a>
            
          </div>
        <span class="more-meta"> 4484 words </span>
        <span class="more-meta"> 9 min read </span>
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Table of Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#requirements">Requirements</a>
<ul>
<li><a href="#target">Target</a></li>
<li><a href="#data-source">Data Source</a>
<ul>
<li><a href="#active-users-info">Active Users&rsquo; Info</a></li>
<li><a href="#data-source-file">Data Source File</a></li>
</ul></li>
<li><a href="#filter-parameters">Filter Parameters</a></li>
<li><a href="#output-format">Output Format</a></li>
</ul></li>
<li><a href="#analysis">Analysis</a>
<ul>
<li><a href="#step1-active-users-info">Step1 Active Users&rsquo; Info</a></li>
<li><a href="#step2-download-log-files">Step2 Download Log Files</a></li>
<li><a href="#step3-merge-line">Step3 Merge Line</a></li>
<li><a href="#step4-filtering-via-keywords">Step4 Filtering Via Keywords</a>
<ul>
<li><a href="#extract-specific-data">Extract Specific Data</a></li>
</ul></li>
<li><a href="#step5-load-data-into-mysql-dbms">Step5 Load Data Into MySQL DBMS</a></li>
</ul></li>
<li><a href="#operation-precedures">Operation Precedures</a>
<ul>
<li><a href="#active-users-info-1">Active Users&rsquo; Info</a></li>
<li><a href="#download-source-log-files">Download Source Log Files</a></li>
<li><a href="#merge-two-lines-into-one-line">Merge Two Lines Into One Line</a></li>
<li><a href="#filter-data-via-keywords">Filter Data Via Keywords</a></li>
<li><a href="#extract-specific-field">Extract Specific Field</a>
<ul>
<li><a href="#extract-change-date">Extract change_date</a></li>
<li><a href="#extract-token">Extract token</a></li>
<li><a href="#extract-mac-id">Extract mac_id</a></li>
</ul></li>
<li><a href="#write-info-new-file">Write Info New File</a></li>
<li><a href="#load-data-into-mysql-dbms">Load Data Into MySQL DBMS</a></li>
</ul></li>
<li><a href="#complete-shell-script">Complete Shell Script</a></li>
<li><a href="#query">Query</a>
<ul>
<li><a href="#directly-search-file">Directly Search File</a></li>
<li><a href="#use-select-statements">Use Select Statements</a></li>
</ul></li>
<li><a href="#references">References</a></li>
<li><a href="#change-logs">Change Logs</a></li>
</ul></li>
</ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <p>接到Java開發人員的需求,從Tomcat日誌中提取最近一個月查詢、購票活躍度最高的5位iOS用戶的token變更頻率。日誌文件在線上生產服務器中，單個文件高達十數GB，無法使用<code>vim</code>打開，只能下載到本機後再進行數據提取操作，以下是完整的記錄。</p>

<p></p>

<h2 id="requirements">Requirements</h2>

<p>需求整理如下</p>

<h3 id="target">Target</h3>

<p>提取最近一個月(2016.11.01~30, 2016.12.01)查詢、購票活躍度最高的5位iOS用戶的token變更頻率</p>

<h3 id="data-source">Data Source</h3>

<h4 id="active-users-info">Active Users&rsquo; Info</h4>

<p>活躍用戶信息查詢，SQL語句由Java開發人員提供 (SQL語句似乎有問題,沒有判斷是否屬於iOS用戶)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="k">select</span> <span class="n">a</span><span class="p">.</span><span class="o">*</span> <span class="k">from</span> <span class="n">t_bus_member</span> <span class="n">a</span> <span class="k">join</span> <span class="p">(</span><span class="k">select</span> <span class="n">member_id</span><span class="p">,</span><span class="k">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">sum</span> <span class="k">from</span> <span class="n">t_bus_ticket</span> <span class="k">where</span> <span class="n">create_time</span> <span class="o">&gt;=</span> <span class="s1">&#39;2016-11-1&#39;</span> <span class="k">and</span> <span class="n">create_time</span> <span class="o">&lt;</span><span class="s1">&#39;2016-12-1&#39;</span> <span class="k">and</span> <span class="n">ticket_status</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">group</span> <span class="k">by</span> <span class="n">member_id</span> <span class="k">order</span> <span class="k">by</span> <span class="k">sum</span> <span class="k">desc</span> <span class="k">limit</span> <span class="mi">5</span><span class="p">)</span> <span class="n">b</span> <span class="k">on</span> <span class="n">a</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">b</span><span class="p">.</span><span class="n">member_id</span><span class="err">\</span><span class="k">G</span></code></pre></td></tr></table>
</div>
</div>
<p>其中含有需要的設備ID (t_bus_member.mac_id)</p>

<h4 id="data-source-file">Data Source File</h4>

<p>日誌文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span></pre></td>
<td class="lntd">
<pre class="chroma">/PATH1/flybus-provider/logs/all.log*
/PATH2/tomcat-flybus-provider/logs/catalina.out</pre></td></tr></table>
</div>
</div>
<h3 id="filter-parameters">Filter Parameters</h3>

<p>日誌在線上生產服務器中，日誌格式</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-txt" data-lang="txt"><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-txt" data-lang="txt">flybus-provider [2016-12-01 00:07:39] 1480408150655-2091 com.raxtone.utils.spring.logger.LoggerAspect:48
INFO : (LoggerAspect.java:48)    请求方法：void com.raxtone.flybus.rpc.rmi.user.IPushTSRmiService.sendTokenToSerer(TokenParam,String,Integer,Integer)，请求参数：[{&#34;cityId&#34;:0,&#34;token&#34;:&#34;80275d72bebcbf9c0d9d5c4f62c7b15e90c6795c5a4a58af79f4f57f47a7590f&#34;},&#34;cb0eeb6990335140b8f65fb3fc9a3f522de48b35&#34;,11,100]</code></pre></td></tr></table>
</div>
</div>
<p>按如下要求在日誌文件中查詢匹配數據</p>

<ol>
<li>含有關鍵詞 <strong><code>sendTokenToSerer</code></strong>；</li>
<li>同時含有設備ID，示例中的<code>cb0eeb6990335140b8f65fb3fc9a3f522de48b35</code>；</li>
</ol>

<p>提取其中的日期，設備ID，token值，在示例中分別是</p>

<table>
<thead>
<tr>
<th>item</th>
<th>details</th>
</tr>
</thead>

<tbody>
<tr>
<td>date</td>
<td><code>2016-12-01 00:07:39</code></td>
</tr>

<tr>
<td>mac_id</td>
<td><code>cb0eeb6990335140b8f65fb3fc9a3f522de48b35</code></td>
</tr>

<tr>
<td>token</td>
<td><code>80275d72bebcbf9c0d9d5c4f62c7b15e90c6795c5a4a58af79f4f57f47a7590f</code></td>
</tr>
</tbody>
</table>

<h3 id="output-format">Output Format</h3>

<p>結果輸出格式 <code>時間|設備編號|token</code></p>

<blockquote>
<p>2016-12-01 00:07:39|cb0eeb6990335140b8f65fb3fc9a3f522de48b35|80275d72bebcbf9c0d9d5c4f62c7b15e90c6795c5a4a58af79f4f57f47a7590f`</p>
</blockquote>

<h2 id="analysis">Analysis</h2>

<h3 id="step1-active-users-info">Step1 Active Users&rsquo; Info</h3>

<p>查詢、購票活躍度最高的5爲iOS用戶的設備ID由開發人員提供的SQL語句獲取。</p>

<h3 id="step2-download-log-files">Step2 Download Log Files</h3>

<p>原始日誌文件總大小達16GB，在生產服務器上進行數據提取操作會對線上業務造成影響；通過<code>sftp</code>將相關日誌拉取到本地進行處理，保存路徑爲<code>/tmp/flybusProvider</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="o">[</span>flying@lempstacker flybusProvider<span class="o">]</span>$ ls -lh
total 16G
-rw-r--r-- <span class="m">1</span> flying flying 100M Dec  <span class="m">2</span> <span class="m">16</span>:34 all.log
-rw-r--r-- <span class="m">1</span> flying flying 105M Dec  <span class="m">2</span> <span class="m">16</span>:34 all.log.2016-11-29
-rw-r--r-- <span class="m">1</span> flying flying 211M Dec  <span class="m">2</span> <span class="m">16</span>:34 all.log.2016-11-30
-rw-r--r-- <span class="m">1</span> flying flying 208M Dec  <span class="m">2</span> <span class="m">16</span>:35 all.log.2016-12-01
-rw-r--r-- <span class="m">1</span> flying flying  16G Dec  <span class="m">2</span> <span class="m">16</span>:33 catalina.out
<span class="o">[</span>flying@lempstacker flybusProvider<span class="o">]</span>$ <span class="nb">pwd</span>
/tmp/flybusProvider
<span class="o">[</span>flying@lempstacker flybusProvider<span class="o">]</span>$ ls -lh
total 16G
-rw-r--r-- <span class="m">1</span> flying flying 100M Dec  <span class="m">2</span> <span class="m">16</span>:34 all.log
-rw-r--r-- <span class="m">1</span> flying flying 105M Dec  <span class="m">2</span> <span class="m">16</span>:34 all.log.2016-11-29
-rw-r--r-- <span class="m">1</span> flying flying 211M Dec  <span class="m">2</span> <span class="m">16</span>:34 all.log.2016-11-30
-rw-r--r-- <span class="m">1</span> flying flying 208M Dec  <span class="m">2</span> <span class="m">16</span>:35 all.log.2016-12-01
-rw-r--r-- <span class="m">1</span> flying flying  16G Dec  <span class="m">2</span> <span class="m">16</span>:33 catalina.out
<span class="o">[</span>flying@lempstacker flybusProvider<span class="o">]</span>$ du -sh
16G	.
<span class="o">[</span>flying@lempstacker flybusProvider<span class="o">]</span>$</code></pre></td></tr></table>
</div>
</div>
<h3 id="step3-merge-line">Step3 Merge Line</h3>

<p>日誌中請求日期和請求體在相鄰的兩行中，須將其合併爲一行，只對指定時間範圍內的數據進行操作，使用命令<code>awk</code>及其中的<code>getline</code>方法實現；</p>

<p>原始數據格式</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-txt" data-lang="txt"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-txt" data-lang="txt">flybus-provider [2016-11-30 00:45:32] 1480408150487-2087 com.raxtone.utils.spring.logger.LoggerAspect:48
INFO : (LoggerAspect.java:48)    请求方法：void com.raxtone.flybus.rpc.rmi.user.IPushTSRmiService.sendTokenToServer(TokenParam,String,Integer,Integer)，请求参数
：[{&#34;cityId&#34;:0,&#34;token&#34;:&#34;843edf6bfd3df2b448f58b762a2e6c06cfae05b0c44ac088edce81dd50c5d4bc&#34;},&#34;bed8a36e77253e1e16972e73b2c8743def6356e7&#34;,11,100]
flybus-provider [2016-11-30 00:45:32] 1480408150487-2087 PushTSLogger:119</code></pre></td></tr></table>
</div>
</div>
<p>期望的數據格式(將兩行合併成一行)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">flybus-provider [2016-11-30 00:45:32] 1480408150487-2087 com.raxtone.utils.spring.logger.LoggerAspect:48 INFO : (LoggerAspect.java:48)    请求方法：void com.raxtone.flybus.rpc.rmi.user.IPushTSRmiService.sendTokenToServer(TokenParam,String,Integer,Integer)，请求参数：[{&#34;cityId&#34;:0,&#34;token&#34;:&#34;843edf6bfd3df2b448f58b762a2e6c06cfae05b0c44ac088edce81dd50c5d4bc&#34;},&#34;bed8a36e77253e1e16972e73b2c8743def6356e7&#34;,11,100]</pre></td></tr></table>
</div>
</div>
<h3 id="step4-filtering-via-keywords">Step4 Filtering Via Keywords</h3>

<p>通過關鍵詞<code>sendTokenToServer</code>和<code>token</code>過濾，提取含有該2個關鍵詞的行，通過命令<code>awk</code>實現。</p>

<h4 id="extract-specific-data">Extract Specific Data</h4>

<ol>
<li><code>token</code>字段通過命令<code>sed</code>提取</li>
<li><code>設備ID</code>、<code>日期</code>字段通過命令<code>awk</code>提取</li>
</ol>

<p>將提取的數據寫入新文件中</p>

<h3 id="step5-load-data-into-mysql-dbms">Step5 Load Data Into MySQL DBMS</h3>

<p>創建數據表，將提取的數據寫入數據庫。</p>

<h2 id="operation-precedures">Operation Precedures</h2>

<h3 id="active-users-info-1">Active Users&rsquo; Info</h3>

<p>從生產數據庫主庫查詢</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="mi">17</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">15</span> <span class="n">flybus</span><span class="o">&gt;</span> <span class="k">select</span> <span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="n">client_id</span><span class="p">,</span><span class="n">a</span><span class="p">.</span><span class="n">mac_id</span> <span class="k">from</span> <span class="n">t_bus_member</span> <span class="n">a</span> <span class="k">join</span> <span class="p">(</span><span class="k">select</span> <span class="n">member_id</span><span class="p">,</span><span class="k">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">sum</span> <span class="k">from</span> <span class="n">t_bus_ticket</span> <span class="k">where</span> <span class="n">create_time</span> <span class="o">&gt;=</span> <span class="s1">&#39;2016-11-1&#39;</span> <span class="k">and</span> <span class="n">create_time</span> <span class="o">&lt;</span><span class="s1">&#39;2016-12-1&#39;</span> <span class="k">and</span> <span class="n">ticket_status</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">group</span> <span class="k">by</span> <span class="n">member_id</span> <span class="k">order</span> <span class="k">by</span> <span class="k">sum</span> <span class="k">desc</span> <span class="k">limit</span> <span class="mi">5</span><span class="p">)</span> <span class="n">b</span> <span class="k">on</span> <span class="n">a</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">b</span><span class="p">.</span><span class="n">member_id</span><span class="err">\</span><span class="k">G</span>
<span class="o">***************************</span> <span class="mi">1</span><span class="p">.</span> <span class="k">row</span> <span class="o">***************************</span>
             <span class="n">id</span><span class="p">:</span> <span class="mi">32177</span>
      <span class="n">client_id</span><span class="p">:</span> <span class="mi">171</span>
         <span class="n">mac_id</span><span class="p">:</span> <span class="n">a58c41716de3c98b0b9b6a44f03442c803d61d78</span>
<span class="o">***************************</span> <span class="mi">2</span><span class="p">.</span> <span class="k">row</span> <span class="o">***************************</span>
             <span class="n">id</span><span class="p">:</span> <span class="mi">37081</span>
      <span class="n">client_id</span><span class="p">:</span> <span class="mi">171</span>
         <span class="n">mac_id</span><span class="p">:</span> <span class="mi">96262</span><span class="n">d20d58519e2ea6ea87f8cb0a5f7653fcc40</span>
<span class="o">***************************</span> <span class="mi">3</span><span class="p">.</span> <span class="k">row</span> <span class="o">***************************</span>
             <span class="n">id</span><span class="p">:</span> <span class="mi">26003</span>
      <span class="n">client_id</span><span class="p">:</span> <span class="mi">171</span>
         <span class="n">mac_id</span><span class="p">:</span> <span class="n">e444928b471124ce31609f992ac0853cbf2a0b8c</span>
<span class="o">***************************</span> <span class="mi">4</span><span class="p">.</span> <span class="k">row</span> <span class="o">***************************</span>
             <span class="n">id</span><span class="p">:</span> <span class="mi">37323</span>
      <span class="n">client_id</span><span class="p">:</span> <span class="mi">171</span>
         <span class="n">mac_id</span><span class="p">:</span> <span class="mi">88</span><span class="n">befa42adb6745cc9c19e18d689f0913290c4d2</span>
<span class="o">***************************</span> <span class="mi">5</span><span class="p">.</span> <span class="k">row</span> <span class="o">***************************</span>
             <span class="n">id</span><span class="p">:</span> <span class="mi">36479</span>
      <span class="n">client_id</span><span class="p">:</span> <span class="mi">169</span>
         <span class="n">mac_id</span><span class="p">:</span> <span class="mi">12</span><span class="n">a352b35e513dc5f341ec35aad12ff</span>
<span class="mi">5</span> <span class="k">rows</span> <span class="k">in</span> <span class="k">set</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">95</span> <span class="n">sec</span><span class="p">)</span>

<span class="mi">17</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">25</span> <span class="n">flybus</span><span class="o">&gt;</span></code></pre></td></tr></table>
</div>
</div>
<p>提取到的数据(设备ID)为</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></pre></td>
<td class="lntd">
<pre class="chroma">a58c41716de3c98b0b9b6a44f03442c803d61d78
96262d20d58519e2ea6ea87f8cb0a5f7653fcc40
e444928b471124ce31609f992ac0853cbf2a0b8c
88befa42adb6745cc9c19e18d689f0913290c4d2
12a352b35e513dc5f341ec35aad12ff</pre></td></tr></table>
</div>
</div>
<h3 id="download-source-log-files">Download Source Log Files</h3>

<p>通過創建SSH Tunnel穿透 <strong>跳板主機</strong> 直連內網主機，利用命令<code>sftp</code>將相關日誌文件下載到本地。</p>

<h3 id="merge-two-lines-into-one-line">Merge Two Lines Into One Line</h3>

<p>將指定時間範圍內的數據行，兩行合併一行，其行首分別是<code>flybus-provider</code>、<code>INFO</code>。</p>

<p>具體命令爲</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">awk <span class="s1">&#39;$1~/flybus-provider/&amp;&amp;($2~/2016-11-[[:digit:]]{2}/||$2~/2016-12-01/){printf $0;getline;print}&#39;</span> /tmp/flybusProvider/* &gt; /tmp/mergeline.txt</code></pre></td></tr></table>
</div>
</div>
<p>提取出的數據文件大小</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="o">[</span>flying@lempstacker ~<span class="o">]</span>$ ls -lh /tmp/mergeline.txt
-rw-rw-r-- <span class="m">1</span> flying flying <span class="m">7</span>.7G Dec  <span class="m">2</span> <span class="m">17</span>:40 /tmp/mergeline.txt
<span class="c1"># 數據行數
</span><span class="c1"></span><span class="o">[</span>flying@lempstacker ~<span class="o">]</span>$ awk <span class="s1">&#39;END{print NR}&#39;</span> /tmp/mergeline.txt
<span class="m">9257670</span>
<span class="o">[</span>flying@lempstacker ~<span class="o">]</span>$</code></pre></td></tr></table>
</div>
</div>
<h3 id="filter-data-via-keywords">Filter Data Via Keywords</h3>

<p>關鍵詞爲<code>sendTokenToServer</code>和<code>token</code>，提取同時含有的數據行</p>

<p>具體命令爲</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">awk <span class="s1">&#39;$0~/sendTokenToServer/&amp;&amp;$0~/&#34;token&#34;/{printf(&#34;%s\n&#34;,$0)}&#39;</span> /tmp/mergeline.txt &gt; /tmp/haskeywords.txt</code></pre></td></tr></table>
</div>
</div>
<p>提取出的數據文件大小</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="o">[</span>flying@lempstacker ~<span class="o">]</span>$ ls -lh /tmp/haskeywords.txt
-rw-rw-r-- <span class="m">1</span> flying flying <span class="m">9</span>.7M Dec  <span class="m">5</span> <span class="m">11</span>:54 /tmp/haskeywords.txt
<span class="c1"># 數據行數
</span><span class="c1"></span><span class="o">[</span>flying@lempstacker ~<span class="o">]</span>$ awk <span class="s1">&#39;END{print NR}&#39;</span> /tmp/haskeywords.txt
<span class="m">25835</span>
<span class="o">[</span>flying@lempstacker ~<span class="o">]</span>$</code></pre></td></tr></table>
</div>
</div>
<h3 id="extract-specific-field">Extract Specific Field</h3>

<p>文件<code>/tmp/haskeywords.txt</code>數據格式爲</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">flybus-provider [2016-11-29 16:23:15] 1480407795138-737 com.raxtone.utils.spring.logger.LoggerAspect:48 INFO : (LoggerAspect.java:48)    请求方法：void com.raxtone.flybus.rpc.rmi.user.IPushTSRmiService.sendTokenToServer(TokenParam,String,Integer,Integer)，请求参数：[{&#34;cityId&#34;:0,&#34;token&#34;:&#34;3d34356980904e8348107081b64112eac0852f3851dd71537fa74d0e9d2fbf41&#34;},&#34;36416&#34;,11,100]</pre></td></tr></table>
</div>
</div>
<p>通過命令</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">sed -r <span class="s1">&#39;s@(\[|\]|\&#34;)@@g&#39;</span></code></pre></td></tr></table>
</div>
</div>
<p>去除日期兩側的方括號<code>[</code>、<code>]</code>以及數據行中的雙引號<code>&quot;</code>。</p>

<p>處理後的格式如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">flybus-provider 2016-11-29 16:23:15 1480407795138-737 com.raxtone.utils.spring.logger.LoggerAspect:48 INFO : (LoggerAspect.java:48)    请求方法：void com.raxtone.flybus.rpc.rmi.user.IPushTSRmiService.sendTokenToServer(TokenParam,String,Integer,Integer)，请求参数：{cityId:0,token:3d34356980904e8348107081b64112eac0852f3851dd71537fa74d0e9d2fbf41},36416,11,100</pre></td></tr></table>
</div>
</div>
<h4 id="extract-change-date">Extract change_date</h4>

<p>通過命令</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">awk <span class="s1">&#39;{printf(&#34;%s %s\n&#34;,$2,$3)}&#39;</span></code></pre></td></tr></table>
</div>
</div>
<p>提取變更日期，輸出爲</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="m">2016</span>-11-29 <span class="m">16</span>:23:15</code></pre></td></tr></table>
</div>
</div>
<p>測試過程</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="o">[</span>flying@lempstacker ~<span class="o">]</span>$ head -1 /tmp/haskeywords.txt  <span class="p">|</span> sed -r <span class="s1">&#39;s@(\[|\]|\&#34;)@@g&#39;</span> <span class="p">|</span> awk <span class="s1">&#39;{printf(&#34;%s %s\n&#34;,$2,$3)}&#39;</span>
<span class="m">2016</span>-11-29 <span class="m">16</span>:23:15
<span class="o">[</span>flying@lempstacker ~<span class="o">]</span>$</code></pre></td></tr></table>
</div>
</div>
<h4 id="extract-token">Extract token</h4>

<p>通過命令</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">sed -r -n <span class="s1">&#39;s@.*token:(.*)}.*@\1@p&#39;</span></code></pre></td></tr></table>
</div>
</div>
<p>提取token，輸出爲</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">3d34356980904e8348107081b64112eac0852f3851dd71537fa74d0e9d2fbf41</code></pre></td></tr></table>
</div>
</div>
<p>測試過程</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="o">[</span>flying@lempstacker ~<span class="o">]</span>$ head -1 /tmp/haskeywords.txt  <span class="p">|</span> sed -r <span class="s1">&#39;s@(\[|\]|\&#34;)@@g&#39;</span> <span class="p">|</span> sed -r -n <span class="s1">&#39;s@.*token:(.*)}.*@\1@p&#39;</span>
3d34356980904e8348107081b64112eac0852f3851dd71537fa74d0e9d2fbf41
<span class="o">[</span>flying@lempstacker ~<span class="o">]</span>$</code></pre></td></tr></table>
</div>
</div>
<h4 id="extract-mac-id">Extract mac_id</h4>

<p>通過命令</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">awk -v <span class="nv">FS</span><span class="o">=</span><span class="s1">&#39;,&#39;</span> <span class="s1">&#39;{print $(NF-2)}&#39;</span></code></pre></td></tr></table>
</div>
</div>
<p>提取設備ID，輸出爲</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="m">36416</span></code></pre></td></tr></table>
</div>
</div>
<p>測試過程</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="o">[</span>flying@lempstacker ~<span class="o">]</span>$ head -1 /tmp/haskeywords.txt  <span class="p">|</span> sed -r <span class="s1">&#39;s@(\[|\]|\&#34;)@@g&#39;</span> <span class="p">|</span> awk -v <span class="nv">FS</span><span class="o">=</span><span class="s1">&#39;,&#39;</span> <span class="s1">&#39;{print $(NF-2)}&#39;</span>
<span class="m">36416</span>
<span class="o">[</span>flying@lempstacker ~<span class="o">]</span>$</code></pre></td></tr></table>
</div>
</div>
<h3 id="write-info-new-file">Write Info New File</h3>

<p>將其取出的數據寫入新文件，具體命令如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nv">resultfile</span><span class="o">=</span><span class="s1">&#39;/tmp/resultfile.txt&#39;</span>
<span class="o">[[</span> -f <span class="s2">&#34;</span><span class="nv">$resultfile</span><span class="s2">&#34;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> rm -f <span class="s2">&#34;</span><span class="nv">$resultfile</span><span class="s2">&#34;</span>
touch <span class="s2">&#34;</span><span class="nv">$resultfile</span><span class="s2">&#34;</span>

<span class="nv">flag</span><span class="o">=</span><span class="m">0</span>
<span class="k">while</span> <span class="nb">read</span> line<span class="p">;</span> <span class="k">do</span>
    <span class="nv">strip_character</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$line</span><span class="s2">&#34;</span> <span class="p">|</span> sed -r <span class="s1">&#39;s@(\[|\]|\&#34;)@@g&#39;</span><span class="k">)</span>
    <span class="nv">change_date</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$strip_character</span><span class="s2">&#34;</span> <span class="p">|</span> awk <span class="s1">&#39;{printf(&#34;%s %s\n&#34;,$2,$3)}&#39;</span><span class="k">)</span>
    <span class="nv">token</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$strip_character</span><span class="s2">&#34;</span> <span class="p">|</span> sed -r -n <span class="s1">&#39;s@.*token:(.*)}.*@\1@p&#39;</span><span class="k">)</span>
    <span class="nv">mac_id</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$strip_character</span><span class="s2">&#34;</span> <span class="p">|</span> awk -v <span class="nv">FS</span><span class="o">=</span><span class="s1">&#39;,&#39;</span> <span class="s1">&#39;{print $(NF-2)}&#39;</span><span class="k">)</span>
    <span class="nb">let</span> <span class="nv">flag</span><span class="o">+=</span><span class="m">1</span>
    <span class="nb">printf</span> <span class="s2">&#34;%d|%s|%s|%s\n&#34;</span> <span class="s2">&#34;</span><span class="nv">$flag</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$mac_id</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$token</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$change_date</span><span class="s2">&#34;</span> &gt;&gt; <span class="s2">&#34;</span><span class="nv">$resultfile</span><span class="s2">&#34;</span>
<span class="k">done</span> &lt; /tmp/haskeywords.txt</code></pre></td></tr></table>
</div>
</div>
<p>提取出的數據文件大小</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="o">[</span>flying@lempstacker ~<span class="o">]</span>$ ls -lh /tmp/resultfile.txt
-rw-rw-r-- <span class="m">1</span> flying flying <span class="m">2</span>.7M Dec  <span class="m">5</span> <span class="m">12</span>:17 /tmp/resultfile.txt
<span class="c1"># 數據行數
</span><span class="c1"></span><span class="o">[</span>flying@lempstacker ~<span class="o">]</span>$ awk <span class="s1">&#39;END{print NR}&#39;</span> /tmp/resultfile.txt
<span class="m">25835</span>
<span class="c1"># 數據格式
</span><span class="c1"></span><span class="o">[</span>flying@lempstacker ~<span class="o">]</span>$ awk <span class="s1">&#39;END{print $0}&#39;</span> /tmp/resultfile.txt
<span class="m">25835</span><span class="p">|</span><span class="m">27441</span><span class="p">|</span>6c565066e2637c6b2b53d2d0e4dae6d4ef21856cc9187ab9d61111692a077c2b<span class="p">|</span><span class="m">2016</span>-12-01 <span class="m">23</span>:54:41
<span class="o">[</span>flying@lempstacker ~<span class="o">]</span>$</code></pre></td></tr></table>
</div>
</div>
<h3 id="load-data-into-mysql-dbms">Load Data Into MySQL DBMS</h3>

<p>將提取出的數據寫入數據表</p>

<ol>
<li>創建數據表</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="c1">-- 刪除存在的同名數據庫
</span><span class="c1"></span><span class="k">drop</span> <span class="k">database</span> <span class="k">if</span> <span class="k">exists</span> <span class="n">userTokenAnalysis</span><span class="p">;</span>

<span class="c1">-- 創建數據庫
</span><span class="c1"></span><span class="k">create</span> <span class="k">database</span> <span class="k">if</span> <span class="k">not</span> <span class="k">exists</span> <span class="n">userTokenAnalysis</span>
    <span class="k">default</span> <span class="nb">character</span> <span class="k">set</span><span class="o">=</span><span class="n">utf8</span>
    <span class="k">default</span> <span class="k">collate</span><span class="o">=</span><span class="n">utf8_general_ci</span><span class="p">;</span>

<span class="c1">-- 進入數據庫
</span><span class="c1"></span><span class="n">use</span> <span class="n">userTokenAnalysis</span><span class="p">;</span>

<span class="c1">-- 創建數據表details
</span><span class="c1"></span><span class="k">create</span> <span class="k">table</span> <span class="k">if</span> <span class="k">not</span> <span class="k">exists</span> <span class="n">details</span> <span class="p">(</span>
    <span class="n">id</span> <span class="n">mediumint</span> <span class="n">unsigned</span> <span class="k">not</span> <span class="k">null</span> <span class="n">auto_increment</span> <span class="k">primary</span> <span class="k">key</span> <span class="k">comment</span> <span class="s1">&#39;primary id&#39;</span><span class="p">,</span>
    <span class="n">mac_id</span> <span class="nb">char</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span> <span class="k">comment</span> <span class="s1">&#39;mac id&#39;</span><span class="p">,</span>
    <span class="n">token</span> <span class="nb">char</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span> <span class="k">comment</span> <span class="s1">&#39;token length 64&#39;</span><span class="p">,</span>
    <span class="n">change_date</span> <span class="k">timestamp</span> <span class="k">null</span> <span class="k">default</span> <span class="k">null</span> <span class="k">comment</span> <span class="s1">&#39;change date&#39;</span><span class="p">,</span>
    <span class="n">storage_time</span> <span class="k">timestamp</span> <span class="k">not</span> <span class="k">null</span> <span class="k">default</span> <span class="k">current_timestamp</span> <span class="k">comment</span> <span class="s1">&#39;item format YYYY-MM-DD HH:MM:SS&#39;</span>
<span class="p">)</span><span class="n">engine</span><span class="o">=</span><span class="n">innodb</span> <span class="k">default</span> <span class="n">charset</span><span class="o">=</span><span class="n">utf8</span> <span class="k">collate</span><span class="o">=</span><span class="n">utf8_general_ci</span> <span class="k">comment</span> <span class="s1">&#39;token mac_id change_date&#39;</span><span class="p">;</span>

<span class="c1">-- 創建索引
</span><span class="c1"></span><span class="k">create</span> <span class="k">index</span> <span class="n">details_mac_id</span> <span class="k">on</span> <span class="n">details</span> <span class="p">(</span><span class="n">mac_id</span><span class="p">)</span> <span class="k">comment</span> <span class="s1">&#39;index mac_id&#39;</span><span class="p">;</span></code></pre></td></tr></table>
</div>
</div>
<ol>
<li>寫入數據庫</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">mysql -e <span class="s2">&#34;load data local infile &#39;/tmp/resultfile.txt&#39; into table userTokenAnalysis.details fields terminated by &#39;|&#39; lines terminated by &#39;\n&#39;;&#34;</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="complete-shell-script">Complete Shell Script</h2>

<p>將上述在本機進行的操作合併成Shell Script，內容如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="cp">#!/bin/bash
</span><span class="cp"></span><span class="c1">#writer: lempstacker
</span><span class="c1">#date: 2016.12.05 12:17 Mon Asia/Shanghai
</span><span class="c1"></span>
awk <span class="s1">&#39;$1~/flybus-provider/&amp;&amp;($2~/2016-11-[[:digit:]]{2}/||$2~/2016-12-01/){printf $0;getline;print}&#39;</span> /tmp/flybusProvider/* &gt; /tmp/mergeline.txt

awk <span class="s1">&#39;$0~/sendTokenToServer/&amp;&amp;$0~/&#34;token&#34;/{printf(&#34;%s\n&#34;,$0)}&#39;</span> /tmp/mergeline.txt &gt; /tmp/haskeywords.txt

mysql -e <span class="s2">&#34;
</span><span class="s2">drop database if exists userTokenAnalysis;
</span><span class="s2">
</span><span class="s2">create database if not exists userTokenAnalysis
</span><span class="s2">    default character set=utf8
</span><span class="s2">    default collate=utf8_general_ci;
</span><span class="s2">
</span><span class="s2">use userTokenAnalysis;
</span><span class="s2">
</span><span class="s2">create table if not exists details (
</span><span class="s2">    id mediumint unsigned not null auto_increment primary key comment &#39;primary id&#39;,
</span><span class="s2">    mac_id char(40) not null comment &#39;mac id&#39;,
</span><span class="s2">    token char(64) not null comment &#39;token length 64&#39;,
</span><span class="s2">    change_date timestamp null default null comment &#39;change date&#39;,
</span><span class="s2">    storage_time timestamp not null default current_timestamp comment &#39;item format YYYY-MM-DD HH:MM:SS&#39;
</span><span class="s2">)engine=innodb default charset=utf8 collate=utf8_general_ci comment &#39;token mac_id change_date&#39;;
</span><span class="s2">
</span><span class="s2">create index details_mac_id on details (mac_id) comment &#39;index mac_id&#39;
</span><span class="s2">&#34;</span>

<span class="nv">resultfile</span><span class="o">=</span><span class="s1">&#39;/tmp/resultfile.txt&#39;</span>
<span class="o">[[</span> -f <span class="s2">&#34;</span><span class="nv">$resultfile</span><span class="s2">&#34;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> rm -f <span class="s2">&#34;</span><span class="nv">$resultfile</span><span class="s2">&#34;</span>
touch <span class="s2">&#34;</span><span class="nv">$resultfile</span><span class="s2">&#34;</span>

<span class="nv">flag</span><span class="o">=</span><span class="m">0</span>
<span class="k">while</span> <span class="nb">read</span> line<span class="p">;</span> <span class="k">do</span>
    <span class="nv">strip_character</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$line</span><span class="s2">&#34;</span> <span class="p">|</span> sed -r <span class="s1">&#39;s@(\[|\]|\&#34;)@@g&#39;</span><span class="k">)</span>
    <span class="nv">change_date</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$strip_character</span><span class="s2">&#34;</span> <span class="p">|</span> awk <span class="s1">&#39;{printf(&#34;%s %s\n&#34;,$2,$3)}&#39;</span><span class="k">)</span>
    <span class="nv">token</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$strip_character</span><span class="s2">&#34;</span> <span class="p">|</span> sed -r -n <span class="s1">&#39;s@.*token:(.*)}.*@\1@p&#39;</span><span class="k">)</span>
    <span class="nv">mac_id</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$strip_character</span><span class="s2">&#34;</span> <span class="p">|</span> awk -v <span class="nv">FS</span><span class="o">=</span><span class="s1">&#39;,&#39;</span> <span class="s1">&#39;{print $(NF-2)}&#39;</span><span class="k">)</span>
    <span class="nb">let</span> <span class="nv">flag</span><span class="o">+=</span><span class="m">1</span>
    <span class="nb">printf</span> <span class="s2">&#34;%d|%s|%s|%s\n&#34;</span> <span class="s2">&#34;</span><span class="nv">$flag</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$mac_id</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$token</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$change_date</span><span class="s2">&#34;</span> &gt;&gt; <span class="s2">&#34;</span><span class="nv">$resultfile</span><span class="s2">&#34;</span>
<span class="k">done</span> &lt; /tmp/haskeywords.txt

<span class="nb">unset</span> flag

mysql -e <span class="s2">&#34;load data local infile &#39;/tmp/resultfile.txt&#39; into table userTokenAnalysis.details fields terminated by &#39;|&#39; lines terminated by &#39;\n&#39;;&#34;</span>

<span class="c1"># rm -f /tmp/mergeline.txt
</span><span class="c1"># rm -f /tmp/haskeywords.txt
</span><span class="c1"># rm -f /tmp/resultfile.txt
</span><span class="c1"></span>
#Script End</code></pre></td></tr></table>
</div>
</div>
<h2 id="query">Query</h2>

<p>數據查詢，可分爲2種</p>

<ul>
<li>直接操作數據文件<code>/tmp/resultfile.txt</code>；</li>
<li>在數據庫中執行select查詢；</li>
</ul>

<h3 id="directly-search-file">Directly Search File</h3>

<p>提取出現次數最高的10個設備ID，並按照出現次數的多寡逆序排列</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="o">[</span>flying@lempstacker ~<span class="o">]</span>$ awk -v <span class="nv">FS</span><span class="o">=</span><span class="s1">&#39;|&#39;</span> <span class="s1">&#39;{arr[$2]++}END{flag=0;PROCINFO[&#34;sorted_in&#34;]=&#34;@val_num_desc&#34;;for (i in arr) if(flag &lt; 10){print i,arr[i];flag++}}&#39;</span> /tmp/resultfile.txt
<span class="m">36416</span> <span class="m">198</span>
<span class="m">29718</span> <span class="m">160</span>
<span class="m">31385</span> <span class="m">158</span>
<span class="m">37493</span> <span class="m">154</span>
<span class="m">31246</span> <span class="m">153</span>
<span class="m">28326</span> <span class="m">149</span>
<span class="m">21157</span> <span class="m">146</span>
488133db68064f8aba9ba08c8ef4e746687568b6 <span class="m">140</span>
<span class="m">35985</span> <span class="m">140</span>
<span class="m">22032</span> <span class="m">136</span>
<span class="o">[</span>flying@lempstacker ~<span class="o">]</span>$</code></pre></td></tr></table>
</div>
</div>
<p>提取出現次數最高的10個設備ID(字符長度大於5)，並按照出現次數的多寡逆序排列</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="o">[</span>flying@lempstacker ~<span class="o">]</span>$ awk -v <span class="nv">FS</span><span class="o">=</span><span class="s1">&#39;|&#39;</span> <span class="s1">&#39;{if(length($2)&gt;5){arr[$2]++}}END{flag=0;PROCINFO[&#34;sorted_in&#34;]=&#34;@val_num_desc&#34;;for (i in arr) if(flag &lt; 10) {print i,arr[i];flag++}}&#39;</span> /tmp/resultfile.txt
488133db68064f8aba9ba08c8ef4e746687568b6 <span class="m">140</span>
d41d8cd98f00b204e9800998ecf8427eaf861266 <span class="m">110</span>
fad24ff33c1c935aeb4355c047b6780ea5862b1f <span class="m">99</span>
bed8a36e77253e1e16972e73b2c8743def6356e7 <span class="m">99</span>
d41d8cd98f00b204e9800998ecf8427e7c0e84ed <span class="m">98</span>
b64fe0e416eecd61bdea35379643846d308f6b97 <span class="m">98</span>
933abe66f2a3ac125f722bf44eb566488aad0c0f <span class="m">92</span>
c3aabfe68db99085463de99f0756874108e90479 <span class="m">92</span>
ae6b851b36b11836c11b86c3d24b2037f32376fa <span class="m">89</span>
afcab9731bd52208a64a0bf15a9ef75b6bcb1ccc <span class="m">87</span>
<span class="o">[</span>flying@lempstacker ~<span class="o">]</span>$</code></pre></td></tr></table>
</div>
</div>
<p>查詢用戶設備ID爲<code>88befa42adb6745cc9c19e18d689f0913290c4d2</code>的數據，格式按<code>日期 設備ID token</code>排列</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="o">[</span>flying@lempstacker ~<span class="o">]</span>$ awk -v <span class="nv">FS</span><span class="o">=</span><span class="s1">&#39;|&#39;</span> <span class="s1">&#39;$2~/88befa42adb6745cc9c19e18d689f0913290c4d2/{printf &#34;%s %s %s\n&#34;,$NF,$2,$3}&#39;</span> /tmp/resultfile.txt
<span class="m">2016</span>-12-01 <span class="m">17</span>:50:56 88befa42adb6745cc9c19e18d689f0913290c4d2 31aa8d0c86a2974e700b2e1c7a1c3d1a9ddf36326cafbc63c5164bdb1ce27a39
<span class="m">2016</span>-12-01 <span class="m">18</span>:18:58 88befa42adb6745cc9c19e18d689f0913290c4d2 31aa8d0c86a2974e700b2e1c7a1c3d1a9ddf36326cafbc63c5164bdb1ce27a39
<span class="m">2016</span>-12-01 <span class="m">18</span>:35:12 88befa42adb6745cc9c19e18d689f0913290c4d2 31aa8d0c86a2974e700b2e1c7a1c3d1a9ddf36326cafbc63c5164bdb1ce27a39
<span class="m">2016</span>-12-01 <span class="m">17</span>:50:56 88befa42adb6745cc9c19e18d689f0913290c4d2 31aa8d0c86a2974e700b2e1c7a1c3d1a9ddf36326cafbc63c5164bdb1ce27a39
<span class="m">2016</span>-12-01 <span class="m">18</span>:18:58 88befa42adb6745cc9c19e18d689f0913290c4d2 31aa8d0c86a2974e700b2e1c7a1c3d1a9ddf36326cafbc63c5164bdb1ce27a39
<span class="m">2016</span>-12-01 <span class="m">18</span>:35:12 88befa42adb6745cc9c19e18d689f0913290c4d2 31aa8d0c86a2974e700b2e1c7a1c3d1a9ddf36326cafbc63c5164bdb1ce27a39
<span class="o">[</span>flying@lempstacker ~<span class="o">]</span>$</code></pre></td></tr></table>
</div>
</div>
<h3 id="use-select-statements">Use Select Statements</h3>

<p>查詢獨立的設備ID數</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="n">MariaDB</span> <span class="p">[</span><span class="n">userTokenAnalysis</span><span class="p">]</span><span class="o">&gt;</span> <span class="k">select</span> <span class="k">count</span><span class="p">(</span><span class="k">distinct</span><span class="p">(</span><span class="n">mac_id</span><span class="p">))</span> <span class="k">as</span> <span class="n">counts</span> <span class="k">from</span> <span class="n">details</span><span class="p">;</span>
<span class="o">+</span><span class="c1">--------+
</span><span class="c1"></span><span class="o">|</span> <span class="n">counts</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">--------+
</span><span class="c1"></span><span class="o">|</span>   <span class="mi">1817</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">--------+
</span><span class="c1"></span><span class="mi">1</span> <span class="k">row</span> <span class="k">in</span> <span class="k">set</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">03</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[</span><span class="n">userTokenAnalysis</span><span class="p">]</span><span class="o">&gt;</span></code></pre></td></tr></table>
</div>
</div>
<p>查詢各設備ID出現的次數(只取10條)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="n">MariaDB</span> <span class="p">[</span><span class="n">userTokenAnalysis</span><span class="p">]</span><span class="o">&gt;</span> <span class="k">select</span> <span class="n">mac_id</span><span class="p">,</span><span class="k">count</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="k">as</span> <span class="n">counts</span> <span class="k">from</span> <span class="n">details</span> <span class="k">group</span> <span class="k">by</span> <span class="n">mac_id</span> <span class="k">order</span> <span class="k">by</span> <span class="n">counts</span> <span class="k">desc</span> <span class="k">limit</span> <span class="mi">10</span><span class="p">;</span>
<span class="o">+</span><span class="c1">------------------------------------------+--------+
</span><span class="c1"></span><span class="o">|</span> <span class="n">mac_id</span>                                   <span class="o">|</span> <span class="n">counts</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">------------------------------------------+--------+
</span><span class="c1"></span><span class="o">|</span> <span class="mi">36416</span>                                    <span class="o">|</span>    <span class="mi">198</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">29718</span>                                    <span class="o">|</span>    <span class="mi">160</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">31385</span>                                    <span class="o">|</span>    <span class="mi">158</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">37493</span>                                    <span class="o">|</span>    <span class="mi">154</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">31246</span>                                    <span class="o">|</span>    <span class="mi">153</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">28326</span>                                    <span class="o">|</span>    <span class="mi">149</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">21157</span>                                    <span class="o">|</span>    <span class="mi">146</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">35985</span>                                    <span class="o">|</span>    <span class="mi">140</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">488133</span><span class="n">db68064f8aba9ba08c8ef4e746687568b6</span> <span class="o">|</span>    <span class="mi">140</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">22032</span>                                    <span class="o">|</span>    <span class="mi">136</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">------------------------------------------+--------+
</span><span class="c1"></span><span class="mi">10</span> <span class="k">rows</span> <span class="k">in</span> <span class="k">set</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">11</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[</span><span class="n">userTokenAnalysis</span><span class="p">]</span><span class="o">&gt;</span></code></pre></td></tr></table>
</div>
</div>
<p>查詢指定的用戶的設備ID出現的次數</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="n">MariaDB</span> <span class="p">[</span><span class="n">userTokenAnalysis</span><span class="p">]</span><span class="o">&gt;</span> <span class="k">select</span> <span class="n">mac_id</span><span class="p">,</span><span class="k">count</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="k">as</span> <span class="n">counts</span> <span class="k">from</span> <span class="n">details</span> <span class="k">where</span> <span class="n">mac_id</span> <span class="k">in</span> <span class="p">(</span><span class="s1">&#39;a58c41716de3c98b0b9b6a44f03442c803d61d78&#39;</span><span class="p">,</span><span class="s1">&#39;96262d20d58519e2ea6ea87f8cb0a5f7653fcc40&#39;</span><span class="p">,</span><span class="s1">&#39;e444928b471124ce31609f992ac0853cbf2a0b8c&#39;</span><span class="p">,</span><span class="s1">&#39;88befa42adb6745cc9c19e18d689f0913290c4d2&#39;</span><span class="p">,</span><span class="s1">&#39;12a352b35e513dc5f341ec35aad12ff&#39;</span><span class="p">)</span> <span class="k">group</span> <span class="k">by</span> <span class="n">mac_id</span> <span class="k">order</span> <span class="k">by</span> <span class="n">counts</span> <span class="k">desc</span><span class="p">;</span>
<span class="o">+</span><span class="c1">------------------------------------------+--------+
</span><span class="c1"></span><span class="o">|</span> <span class="n">mac_id</span>                                   <span class="o">|</span> <span class="n">counts</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">------------------------------------------+--------+
</span><span class="c1"></span><span class="o">|</span> <span class="n">a58c41716de3c98b0b9b6a44f03442c803d61d78</span> <span class="o">|</span>     <span class="mi">50</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">88</span><span class="n">befa42adb6745cc9c19e18d689f0913290c4d2</span> <span class="o">|</span>      <span class="mi">6</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">96262</span><span class="n">d20d58519e2ea6ea87f8cb0a5f7653fcc40</span> <span class="o">|</span>      <span class="mi">5</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">------------------------------------------+--------+
</span><span class="c1"></span><span class="mi">3</span> <span class="k">rows</span> <span class="k">in</span> <span class="k">set</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">04</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[</span><span class="n">userTokenAnalysis</span><span class="p">]</span><span class="o">&gt;</span></code></pre></td></tr></table>
</div>
</div>
<p>查詢設備ID<code>a58c41716de3c98b0b9b6a44f03442c803d61d78</code>各token出現的次數</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="n">MariaDB</span> <span class="p">[</span><span class="n">userTokenAnalysis</span><span class="p">]</span><span class="o">&gt;</span> <span class="k">select</span> <span class="n">token</span><span class="p">,</span><span class="k">count</span><span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="k">as</span> <span class="n">counts</span> <span class="k">from</span> <span class="n">details</span> <span class="k">where</span> <span class="n">mac_id</span><span class="o">=</span><span class="s1">&#39;a58c41716de3c98b0b9b6a44f03442c803d61d78&#39;</span> <span class="k">group</span> <span class="k">by</span> <span class="n">token</span> <span class="k">desc</span><span class="p">;</span>
<span class="o">+</span><span class="c1">------------------------------------------------------------------+--------+
</span><span class="c1"></span><span class="o">|</span> <span class="n">token</span>                                                            <span class="o">|</span> <span class="n">counts</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">------------------------------------------------------------------+--------+
</span><span class="c1"></span><span class="o">|</span> <span class="mi">12</span><span class="n">f8416a809e895caaba4903a3dcd916c0a0ea18fb135f968601d842c09964ed</span> <span class="o">|</span>     <span class="mi">50</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">------------------------------------------------------------------+--------+
</span><span class="c1"></span><span class="mi">1</span> <span class="k">row</span> <span class="k">in</span> <span class="k">set</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">04</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[</span><span class="n">userTokenAnalysis</span><span class="p">]</span><span class="o">&gt;</span></code></pre></td></tr></table>
</div>
</div>
<p>在數據庫中將查詢到的數據提取到外部文件中</p>

<p>文件默認不存在,如存在會報錯</p>

<blockquote>
<p>ERROR 1086 (HY000): File &lsquo;/tmp/mysqlextractdata.txt&rsquo; already exists</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="n">MariaDB</span> <span class="p">[(</span><span class="k">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="k">select</span> <span class="n">change_date</span><span class="p">,</span><span class="n">mac_id</span><span class="p">,</span><span class="n">token</span> <span class="k">into</span> <span class="n">outfile</span> <span class="s1">&#39;/tmp/mysqlextractdata.txt&#39;</span> <span class="n">fields</span> <span class="n">terminated</span> <span class="k">by</span> <span class="s1">&#39; &#39;</span> <span class="n">lines</span> <span class="n">terminated</span> <span class="k">by</span> <span class="s1">&#39;\n&#39;</span> <span class="k">from</span> <span class="n">userTokenAnalysis</span><span class="p">.</span><span class="n">details</span> <span class="k">order</span> <span class="k">by</span> <span class="n">mac_id</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">25835</span> <span class="k">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">09</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[(</span><span class="k">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">exit</span>
<span class="n">Bye</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="o">[</span>flying@lempstacker ~<span class="o">]</span>$ awk <span class="s1">&#39;END{print NR}&#39;</span> /tmp/mysqlextractdata.txt
<span class="m">25835</span>
<span class="o">[</span>flying@lempstacker ~<span class="o">]</span>$</code></pre></td></tr></table>
</div>
</div>
<p>在Bash Shell中執行SQL將查詢數據導入到文件中</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="o">[</span>flying@lempstacker ~<span class="o">]</span>$ mysql -Bse <span class="s2">&#34;select change_date,mac_id,token from userTokenAnalysis.details where mac_id in (&#39;a58c41716de3c98b0b9b6a44f03442c803d61d78&#39;,&#39;96262d20d58519e2ea6ea87f8cb0a5f7653fcc40&#39;,&#39;e444928b471124ce31609f992ac0853cbf2a0b8c&#39;,&#39;88befa42adb6745cc9c19e18d689f0913290c4d2&#39;,&#39;12a352b35e513dc5f341ec35aad12ff&#39;) order by mac_id;&#34;</span> &gt; /tmp/mysqlextractdata.txt
<span class="o">[</span>flying@lempstacker ~<span class="o">]</span>$ awk <span class="s1">&#39;END{print NR}&#39;</span> /tmp/mysqlextractdata.txt
<span class="m">61</span>
<span class="o">[</span>flying@lempstacker ~<span class="o">]</span>$</code></pre></td></tr></table>
</div>
</div>
<h2 id="references">References</h2>

<ul>
<li><a href="https://dev.mysql.com/doc/refman/5.7/en/load-data.html">LOAD DATA INFILE Syntax</a></li>
<li><a href="https://dev.mysql.com/doc/refman/5.7/en/select-into.html">SELECT &hellip; INTO Syntax</a></li>
</ul>

<h2 id="change-logs">Change Logs</h2>

<ul>
<li>2016.12.05 15:29 Mon Asia/Shanghai

<ul>
<li>初稿完成</li>
</ul></li>
<li>2018.04.11 09:37 Wed America/Boston

<ul>
<li>勘誤，遷移到新Blog</li>
</ul></li>
</ul>
    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">mitui</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">2018-04-11</span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>

    
    
<div class="post-reward">
  <input type="checkbox" name="reward" id="reward" hidden />
  <label class="reward-button" for="reward">Reward</label>
  <div class="qr-code">
    
    
      <label class="qr-code-image" for="reward">
        <img class="image" src="/path/to/your/wechat-qr-code.png">
        <span>Wechat</span>
      </label>
    
      <label class="qr-code-image" for="reward">
        <img class="image" src="/path/to/your/alipay-qr-code.png">
        <span>Alipay</span>
      </label>
  </div>
</div>

    <footer class="post-footer">
      <div class="post-tags">
          
          <a href="/tags/awk/">awk</a>
          
          <a href="/tags/sed/">sed</a>
          
          <a href="/tags/shell-script/">Shell Script</a>
          
          <a href="/tags/mysql/">MySQL</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/2016/setting-up-tor-browser-on-gnu-linux/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Setting Up Tor Browser On GNU/Linux</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        
          <a class="next" href="/2016/self-developing-asset-management-platform-based-on-symfony-framework/">
            <span class="next-text nav-default">Self-Developing Asset Management Platform Based On Symfony Framework</span>
            <span class="prev-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
    

  <div class="disqus-button" id="load_disqus" onclick="load_disqus()">
      Show Disqus Comments
    </div>
    <div id="disqus_thread"></div>
    <script type="text/javascript">
    function load_disqus() {
        
        
        if (window.location.hostname === 'localhost') return;

        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        var disqus_shortname = 'MetaDefine';
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);

        $('#load_disqus').remove();
    };
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    

  

  
  </article>
        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:jason.chansz@gmail.com" rel="me noopener" class="iconfont icon-email"
        title="email" target="_blank">
      </a>
  <a href="/index.xml" rel="noopener" type="application/rss+xml" class="iconfont icon-rss"
    title="rss" target="_blank">
  </a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    2018
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span><span class="author">mitui</span></span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
<script type="text/javascript" src="/dist/jane.min.js?v=2.7.0"></script>
  <script type="text/javascript">
    window.MathJax = {
      showProcessingMessages: false,
      messageStyle: 'none'
    };
  </script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML' async></script>





  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  





</body>
</html>
